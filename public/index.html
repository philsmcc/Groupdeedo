<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>GroupDeeDo - Create Instant Group Chats of any Size.</title>
    <meta name="description" content="Instantly create or join public or private groups. No account or app download required!">
    <meta name="theme-color" content="#FF5700">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Groupdeedo">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/groupdeedo-app-icon.png">
    <link rel="apple-touch-icon" href="/groupdeedo-app-icon.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Terms of Service Modal -->
    <div id="tosModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Welcome to Groupdeedo</h2>
            </div>
            <div class="modal-body">
                <p>üí¨ <strong>Anonymous group chat</strong></p>
                <p>By using Groupdeedo, you agree to:</p>
                <ul>
                    <li>Be respectful and kind to others</li>
                    <li>Not share personal information</li>
                    <li>Not post illegal or harmful content</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button id="agreeTos" class="btn btn-primary">I Agree & Continue</button>
            </div>
        </div>
    </div>
    
    <!-- Channel List Screen (Home) -->
    <div id="channelListScreen" class="channel-list-screen" style="display: none;">
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">
                    <img src="/groupdeedo-logo.png" alt="Groupdeedo" class="header-logo">
                </h1>
                <button id="channelSettingsBtn" class="settings-btn" title="Settings">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
        </header>
        
        <!-- Main Settings Panel (for channel list screen) -->
        <div id="mainSettingsPanel" class="settings-panel">
            <div class="settings-content">
                <div class="settings-header">
                    <h3>Settings</h3>
                    <button id="closeMainSettings" class="close-btn">‚úï</button>
                </div>
                
                <div class="setting-group">
                    <label for="mainDisplayName">Posting as:</label>
                    <input type="text" id="mainDisplayName" placeholder="Anonymous" maxlength="20">
                    <small class="setting-help">This name will be used in all your channels.</small>
                </div>
                
                <div class="setting-group">
                    <button id="mainInstallAppBtn" class="btn btn-primary" style="display: none; width: 100%;">
                        üì± Install App
                    </button>
                </div>
                
                <div class="setting-group settings-ok-container">
                    <button id="mainSettingsOk" class="btn btn-primary settings-ok">‚úì OK</button>
                </div>
            </div>
        </div>
        
        <main class="channel-list-container">
            <div class="channel-list-header">
                <h2>Your Channels</h2>
                <p class="channel-list-subtitle">Tap a channel to start chatting</p>
            </div>
            
            <div id="channelList" class="channel-list">
                <!-- Channels will be added here dynamically -->
                <div class="empty-channels-message">
                    <p>No channels yet!</p>
                    <p>Add a channel to get started.</p>
                </div>
            </div>
            
            <div class="add-channel-section">
                <div class="add-channel-input-group">
                    <input type="text" id="newChannelInput" placeholder="Enter channel name..." maxlength="50">
                    <button id="addChannelBtn" class="btn btn-primary">+ Add</button>
                </div>
                <p class="add-channel-help">
                    <small>Create or join a channel by entering it's name. Choose an obscure channel name and share with your friends for private conversations or choose a generic name like "baseball" for general public discussion.</small>
                </p>
            </div>
        </main>
    </div>
    
    <!-- Main App Container (Chat View) -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <button id="backToChannelsBtn" class="back-btn" title="Back to Channels">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <h1 class="app-title channel-title">
                    <span id="currentChannelName">Channel</span>
                </h1>
                <button id="settingsBtn" class="settings-btn" title="Settings">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Connection Status -->
            <div id="connectionStatus" class="connection-status">
                <span class="status-indicator"></span>
                <span class="status-text">Connecting...</span>
            </div>
        </header>
        
        <!-- Settings Panel -->
        <div id="settingsPanel" class="settings-panel">
            <div class="settings-content">
                <div class="settings-header">
                    <h3>Settings</h3>
                    <button id="closeSettings" class="close-btn">‚úï</button>
                </div>
                
                <div class="setting-group">
                    <label for="displayName">Posting as:</label>
                    <input type="text" id="displayName" placeholder="Anonymous" maxlength="20">
                </div>
                
                <div class="setting-group">
                    <button id="shareChannelBtn" class="btn btn-secondary" style="width: 100%;">
                        üì§ Share This Channel
                    </button>
                </div>
                
                <div class="setting-group">
                    <button id="leaveChannelBtn" class="btn btn-danger" style="width: 100%;">
                        üö™ Leave Channel
                    </button>
                </div>
                
                <div class="setting-group">
                    <button id="installAppBtn" class="btn btn-primary" style="display: none; width: 100%;">
                        üì± Install App
                    </button>
                </div>
                
                <div class="setting-group settings-ok-container">
                    <button id="settingsOk" class="btn btn-primary settings-ok">‚úì OK</button>
                </div>
            </div>
        </div>
        
        <!-- Chat Messages Container -->
        <main class="chat-container">
            <div id="messagesContainer" class="messages">
                <div class="welcome-message">
                    <p>üéâ Welcome to Groupdeedo!</p>
                    <p>Chat with others in the same channel.</p>
                    <p>Tap the gear icon ‚öôÔ∏è to set your name or join a private channel.</p>
                </div>
            </div>
        </main>
        
        <!-- Message Input -->
        <footer class="message-input-container">
            <div class="input-group">
                <button id="imageBtn" class="image-btn" title="Add image">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21,15 16,10 5,21"></polyline>
                    </svg>
                </button>
                
                <div class="message-input-wrapper">
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <div id="imagePreview" class="image-preview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview">
                        <button id="removeImage" class="remove-image">‚úï</button>
                    </div>
                    <textarea 
                        id="messageInput" 
                        placeholder="Type a message..." 
                        rows="1"
                        maxlength="500"
                    ></textarea>
                </div>
                
                <button id="sendBtn" class="send-btn" disabled title="Send message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                    </svg>
                </button>
            </div>
        </footer>
    </div>
    
    <!-- Privacy Key Share Modal -->
    <div id="shareModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share Privacy Key</h3>
                <button id="closeShareModal" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="share-content">
                    <div class="qr-container">
                        <div id="qrCode"></div>
                    </div>
                    <div class="share-options">
                        <div class="share-url">
                            <input type="text" id="shareUrl" readonly>
                            <button id="copyUrl" class="btn btn-small">Copy</button>
                        </div>
                        <p><small>Share this QR code or link with friends to join your private chat using this privacy key.</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Loading Groupdeedo...</p>
    </div>
    
    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- QR Code library (local copy to avoid CORS issues) -->
    <script src="/qrcode.min.js"></script>
    <script src="/app.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        let deferredPrompt;
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        // PWA Install Prompt Handling
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show the install buttons in both settings panels
            const installBtn = document.getElementById('installAppBtn');
            const mainInstallBtn = document.getElementById('mainInstallAppBtn');
            if (installBtn) installBtn.style.display = 'block';
            if (mainInstallBtn) mainInstallBtn.style.display = 'block';
        });
        
        // Handle install button click
        document.addEventListener('DOMContentLoaded', function() {
            const installButtons = [
                document.getElementById('installAppBtn'),
                document.getElementById('mainInstallAppBtn')
            ];
            
            installButtons.forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', async () => {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice;
                            console.log(`User response to the install prompt: ${outcome}`);
                            deferredPrompt = null;
                            // Hide all install buttons
                            installButtons.forEach(b => { if (b) b.style.display = 'none'; });
                        }
                    });
                }
            });
        });
        
        // Hide install button if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            const installBtn = document.getElementById('installAppBtn');
            const mainInstallBtn = document.getElementById('mainInstallAppBtn');
            if (installBtn) installBtn.style.display = 'none';
            if (mainInstallBtn) mainInstallBtn.style.display = 'none';
            deferredPrompt = null;
        });
    </script>
</body>
</html>